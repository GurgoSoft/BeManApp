{% extends "base.html" %}
{% load i18n %}
{% load form_extras %}
{% block title %}{{ modo|title }} {% trans "Evento" %}{% endblock %}
{% block content %}
<h1 class="mb-3">{{ modo|title }} {% trans "Evento" %}</h1>

<div class="alert alert-info" role="alert">
  <div class="fw-semibold mb-1">{% trans "Tips para publicar" %}</div>
  <ul class="mb-0 ps-3">
    <li>{% trans "Para hoy: mínimo 2 horas de anticipación; otros días: 5 minutos" %}</li>
    <li>{% trans "Imagen JPG/PNG/WEBP (máx. 3MB)" %}</li>
    <li>{% trans "Precio en COP enteros (0 si es gratuito)" %}</li>
  </ul>
</div>

<form method="post" enctype="multipart/form-data" class="row g-4 needs-validation" novalidate>
  {% csrf_token %}
  {% if form.non_field_errors %}
  <div class="col-12">
    <div class="alert alert-danger" role="alert">
      {% for err in form.non_field_errors %}
        <div>{{ err }}</div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header"><i class="ri-information-line me-1"></i>{% trans "Detalles del evento" %}</div>
      <div class="card-body row g-3">
        <div class="col-12">
          <label class="form-label" for="id_titulo">{% trans "Título" %}</label>
          {{ form.titulo|add_class:"form-control" }}
          {% if form.titulo.errors %}
            <div class="invalid-feedback d-block">{{ form.titulo.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text"><span id="titulo-count">0</span>/120</div>
        </div>
        <div class="col-12">
          <label class="form-label" for="id_nombre">{% trans "Nombre interno (slug)" %}</label>
          <div class="input-group">
            {{ form.nombre|add_class:"form-control" }}
            <button class="btn btn-outline-secondary" type="button" id="slugify-btn">{% trans "Auto" %}</button>
          </div>
          {% if form.nombre.errors %}
            <div class="invalid-feedback d-block">{{ form.nombre.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text">{% trans "Se usa como slug interno único." %}</div>
        </div>
        <div class="col-12">
          <label class="form-label" for="id_descripcion_corta">{% trans "Descripción corta" %}</label>
          {{ form.descripcion_corta|add_class:"form-control" }}
          {% if form.descripcion_corta.errors %}
            <div class="invalid-feedback d-block">{{ form.descripcion_corta.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text"><span id="desc-count">0</span>/500</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><i class="ri-calendar-event-line me-1"></i>{% trans "Logística" %}</div>
      <div class="card-body row g-3">
        <div class="col-md-6">
          <label class="form-label" for="id_fecha">{% trans "Fecha y hora" %}</label>
          <div class="input-group">
            <span class="input-group-text"><i class="ri-time-line"></i></span>
            {{ form.fecha|add_class:"form-control" }}
          </div>
          {% if form.fecha.errors %}
            <div class="invalid-feedback d-block">{{ form.fecha.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text">{% trans "Si es hoy, mínimo 2 horas de anticipación; otros días, al menos 5 minutos (máx. 2 años)." %}</div>
        </div>
        <div class="col-md-6">
          <label class="form-label" for="id_lugar">{% trans "Lugar" %}</label>
          <div class="input-group">
            <span class="input-group-text"><i class="ri-map-pin-2-line"></i></span>
            {{ form.lugar|add_class:"form-control" }}
          </div>
          {% if form.lugar.errors %}
            <div class="invalid-feedback d-block">{{ form.lugar.errors|join:', ' }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label" for="id_precio">{% trans "Precio" %}</label>
          <div class="input-group">
            <span class="input-group-text">COP</span>
            {{ form.precio|add_class:"form-control" }}
          </div>
          {% if form.precio.errors %}
            <div class="invalid-feedback d-block">{{ form.precio.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text">{% trans "Solo números enteros en COP. 0 si es gratuito." %}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card">
      <div class="card-header"><i class="ri-image-add-line me-1"></i>{% trans "Imagen de portada" %}</div>
      <div class="card-body">
        <div class="mb-3 text-center">
          <img id="preview-img" src="{% if form.instance and form.instance.imagen %}{{ form.instance.imagen.url }}{% endif %}" alt="preview" class="rounded border w-100" style="max-height: 220px; object-fit: cover; background:#111;">
        </div>
        <label class="form-label" for="id_imagen">{% trans "Subir imagen" %}</label>
        {{ form.imagen|add_class:"form-control" }}
        {% if form.imagen.errors %}
          <div class="invalid-feedback d-block">{{ form.imagen.errors|join:', ' }}</div>
        {% endif %}
        <div class="form-text">{% trans "Formatos permitidos: JPG, PNG, WEBP. Máx 3MB." %}</div>
      </div>
    </div>
    <div class="d-grid mt-3">
      <button class="btn btn-primary" type="submit"><i class="ri-send-plane-line me-1"></i>{% trans "Publicar" %}</button>
      <a href="{% url 'admin_evento_list' %}" class="btn btn-outline-primary mt-2">{% trans "Cancelar" %}</a>
    </div>
  </div>
</form>

<script>
(function(){
  const $ = (sel) => document.querySelector(sel);
  const titulo = $('#id_titulo');
  const nombre = $('#id_nombre');
  const desc = $('#id_descripcion_corta');
  const fecha = $('#id_fecha');
  const precio = $('#id_precio');
  const tituloCount = $('#titulo-count');
  const descCount = $('#desc-count');
  const slugBtn = $('#slugify-btn');
  const imgInput = $('#id_imagen');
  const preview = $('#preview-img');
  let userTouchedSlug = false;

  function slugify(str){
    return (str||'')
      .toString().normalize('NFD').replace(/\p{Diacritic}/gu, '')
      .toLowerCase().replace(/[^a-z0-9]+/g,'-')
      .replace(/(^-|-$)/g,'').slice(0,140);
  }
  function updateCount(el, counterEl, max){
    if(!el || !counterEl) return;
    const val = (el.value||'');
    counterEl.textContent = `${val.length}`;
    if(val.length > max){
      el.classList.add('is-invalid');
    } else {
      el.classList.remove('is-invalid');
    }
  }
  function validateFecha(){
    if(!fecha) return;
    const val = fecha.value;
    if(!val) return;
    const dt = new Date(val);
    const now = new Date();
    const min = new Date(now.getTime() + 5*60000);
    const max = new Date(now.getTime() + 2*365*24*60*60000);
    if(dt < min || dt > max){
      fecha.classList.add('is-invalid');
    } else {
      fecha.classList.remove('is-invalid');
    }
  }
  function numbersOnly(e){
    const v = (e.target.value||'');
    e.target.value = v.replace(/\D+/g,'');
  }
  function normalizePrecio(){
    if(!precio) return;
    if(precio.value === '') precio.value = '0';
    if(Number(precio.value) < 0){
      precio.value = '0';
    }
  }
  titulo && titulo.addEventListener('input', ()=> updateCount(titulo, tituloCount, 120));
  desc && desc.addEventListener('input', ()=> updateCount(desc, descCount, 500));
  nombre && nombre.addEventListener('input', ()=> { userTouchedSlug = true; });
  slugBtn && slugBtn.addEventListener('click', ()=> { if(titulo && nombre){ nombre.value = slugify(nombre.value||titulo.value); userTouchedSlug = true; } });
  titulo && titulo.addEventListener('input', ()=> { if(!userTouchedSlug && nombre){ nombre.value = slugify(titulo.value); } });
  fecha && fecha.addEventListener('change', validateFecha);
  precio && precio.addEventListener('input', numbersOnly);
  precio && precio.addEventListener('blur', normalizePrecio);
  // init
  updateCount(titulo, tituloCount, 120);
  updateCount(desc, descCount, 500);
  validateFecha();
  if(imgInput && preview){
    imgInput.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const okTypes = ['image/jpeg','image/png','image/webp'];
      if(!okTypes.includes(f.type) || f.size > 3*1024*1024){
        imgInput.value = '';
        alert('Archivo inválido. Usa JPG, PNG o WEBP, máx 3MB.');
        return;
      }
      const url = URL.createObjectURL(f);
      preview.src = url;
    });
  }
})();
</script>
{% endblock %}