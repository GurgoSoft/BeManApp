{% extends "base.html" %}
{% load i18n %}
{% load form_extras %}
{% block title %}{{ modo|title }} {% trans "Evento" %}{% endblock %}
{% block extra_head %}
<!-- Google Maps Places API -->
<script>
// Handler de errores de autenticaci√≥n
window.gm_authFailure = function() {
  console.error('‚ùå ERROR DE AUTENTICACI√ìN: La API Key no es v√°lida o las APIs no est√°n habilitadas');
  console.log('üëâ Ve a: https://console.cloud.google.com/apis/library');
  console.log('üëâ Habilita: Maps JavaScript API y Places API');
};
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAc7L-zDl-Izz1RmyCRniU97l8ehcknvLs&libraries=places&language=es&region=CO" 
        onerror="console.error('‚ùå ERROR DE RED: No se pudo cargar el script de Google Maps')"></script>
<script>
// Verificar si se carg√≥ correctamente
if (typeof google !== 'undefined' && google.maps) {
  console.log('‚úÖ Google Maps script cargado exitosamente');
} else {
  console.error('‚ùå Google Maps no est√° disponible despu√©s de cargar el script');
}
</script>
<style>
/* Estilos personalizados para botones de fecha */
.btn-group-sm .btn {
  font-size: 0.875rem;
  padding: 0.375rem 0.75rem;
  border-radius: 0.25rem;
  transition: all 0.3s ease;
  font-weight: 500;
}

.btn-outline-primary {
  color: #0d6efd;
  border-color: #0d6efd;
  background: linear-gradient(135deg, rgba(13, 110, 253, 0.05), rgba(212, 175, 55, 0.05));
}

.btn-outline-primary:hover {
  color: #fff;
  background: linear-gradient(135deg, #0d6efd, #0b5ed7);
  border-color: #0b5ed7;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

.btn-outline-primary:active,
.btn-outline-primary.active {
  color: #fff;
  background: linear-gradient(135deg, #d4af37, #b8941f) !important;
  border-color: #d4af37 !important;
  transform: scale(0.95);
  box-shadow: 0 2px 8px rgba(212, 175, 55, 0.4) !important;
}

.btn-outline-primary i {
  font-size: 1rem;
}

/* Preview de fecha con estilo */
#fecha-preview {
  display: inline-block;
  padding: 0.25rem 0;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#fecha-preview strong {
  font-weight: 600;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

/* Mejorar el input de fecha */
input[type="datetime-local"] {
  cursor: pointer;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

input[type="datetime-local"]:focus {
  border-color: #d4af37;
  box-shadow: 0 0 0 0.25rem rgba(212, 175, 55, 0.25);
}

input[type="datetime-local"]:hover {
  border-color: #0d6efd;
}
</style>
{% endblock %}
{% block content %}
<h1 class="mb-3">{{ modo|title }} {% trans "Evento" %}</h1>

<div class="alert alert-info" role="alert">
  <div class="fw-semibold mb-1">{% trans "Tips para publicar" %}</div>
  <ul class="mb-0 ps-3">
    <li>{% trans "Imagen JPG/PNG/WEBP (m√°x. 3MB)" %}</li>
    <li>{% trans "Precio en COP enteros (0 si es gratuito)" %}</li>
    <li>{% trans "Selecciona una fecha futura para el evento" %}</li>
  </ul>
</div>

<form method="post" enctype="multipart/form-data" class="row g-4 needs-validation" novalidate>
  {% csrf_token %}
  {% if form.non_field_errors %}
  <div class="col-12">
    <div class="alert alert-danger" role="alert">
      {% for err in form.non_field_errors %}
        <div>{{ err }}</div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header"><i class="ri-information-line me-1"></i>{% trans "Detalles del evento" %}</div>
      <div class="card-body row g-3">
        <div class="col-12">
          <label class="form-label" for="id_titulo">{% trans "T√≠tulo" %}</label>
          {{ form.titulo|add_class:"form-control" }}
          {% if form.titulo.errors %}
            <div class="invalid-feedback d-block">{{ form.titulo.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text"><span id="titulo-count">0</span>/120</div>
        </div>
        <div class="col-12">
          <label class="form-label" for="id_nombre">{% trans "Nombre interno (slug)" %}</label>
          <div class="input-group">
            {{ form.nombre|add_class:"form-control" }}
            <button class="btn btn-outline-secondary" type="button" id="slugify-btn">{% trans "Auto" %}</button>
          </div>
          {% if form.nombre.errors %}
            <div class="invalid-feedback d-block">{{ form.nombre.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text">{% trans "Se usa como slug interno √∫nico." %}</div>
        </div>
        <div class="col-12">
          <label class="form-label" for="id_descripcion_corta">{% trans "Descripci√≥n corta" %}</label>
          {{ form.descripcion_corta|add_class:"form-control" }}
          {% if form.descripcion_corta.errors %}
            <div class="invalid-feedback d-block">{{ form.descripcion_corta.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text"><span id="desc-count">0</span>/500</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><i class="ri-calendar-event-line me-1"></i>{% trans "Log√≠stica" %}</div>
      <div class="card-body row g-3">
        <div class="col-md-6">
          <label class="form-label" for="id_tipo_evento">{% trans "Tipo de evento" %}</label>
          {{ form.tipo_evento|add_class:"form-select" }}
          {% if form.tipo_evento.errors %}
            <div class="invalid-feedback d-block">{{ form.tipo_evento.errors|join:', ' }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label" for="id_fecha">{% trans "Fecha y hora" %}</label>
          <div class="input-group">
            <span class="input-group-text"><i class="ri-calendar-event-line"></i></span>
            {{ form.fecha|add_class:"form-control" }}
          </div>
          {% if form.fecha.errors %}
            <div class="invalid-feedback d-block">{{ form.fecha.errors|join:', ' }}</div>
          {% endif %}
          <div class="fecha-error-msg text-danger small mt-1" style="display:none;"></div>
          <div class="form-text">
            <span id="fecha-preview" class="fw-normal"></span>
          </div>
        </div>
        
        <!-- Campos para evento presencial -->
        <div class="col-12 evento-presencial-fields">
          <label class="form-label" for="id_lugar">{% trans "Direcci√≥n del lugar" %}</label>
          {{ form.lugar|add_class:"form-control" }}
          {% if form.lugar.errors %}
            <div class="invalid-feedback d-block">{{ form.lugar.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text">
            <i class="ri-map-pin-line me-1"></i>
            {% trans "Comienza a escribir la direcci√≥n y selecciona una opci√≥n de las sugerencias." %}
          </div>
          {{ form.latitud }}
          {{ form.longitud }}
        </div>

        <!-- Campos para evento virtual -->
        <div class="col-12 evento-virtual-fields" style="display:none;">
          <label class="form-label" for="id_plataforma_virtual">{% trans "Plataforma virtual" %}</label>
          {{ form.plataforma_virtual|add_class:"form-select" }}
          {% if form.plataforma_virtual.errors %}
            <div class="invalid-feedback d-block">{{ form.plataforma_virtual.errors|join:', ' }}</div>
          {% endif %}
        </div>
        <div class="col-12 evento-virtual-fields" style="display:none;">
          <label class="form-label" for="id_link_virtual">{% trans "Link de la reuni√≥n" %}</label>
          <div class="input-group">
            <span class="input-group-text"><i class="ri-vidicon-line"></i></span>
            {{ form.link_virtual|add_class:"form-control" }}
          </div>
          {% if form.link_virtual.errors %}
            <div class="invalid-feedback d-block">{{ form.link_virtual.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text">{% trans "Link completo (ej: https://zoom.us/j/123456789)" %}</div>
        </div>

        <div class="col-md-6">
          <label class="form-label" for="id_precio">{% trans "Precio (COP)" %}</label>
          <div class="input-group">
            <span class="input-group-text"><strong>$</strong></span>
            {{ form.precio|add_class:"form-control" }}
            <span class="input-group-text">COP</span>
          </div>
          {% if form.precio.errors %}
            <div class="invalid-feedback d-block">{{ form.precio.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text">
            <i class="ri-money-dollar-circle-line me-1"></i>
            {% trans "Formato: 1.000 | 50.000 | 1.000.000 (sin decimales). Deja en 0 si es gratuito." %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card">
      <div class="card-header"><i class="ri-image-add-line me-1"></i>{% trans "Imagen de portada" %}</div>
      <div class="card-body">
        <div id="preview-container" class="mb-3" style="min-height: 240px; max-height: 240px; background: linear-gradient(135deg, var(--bm-azul-800), var(--bm-azul-700)); border-radius: 0.375rem; overflow: hidden; position: relative;">
          <img id="preview-img" 
               src="" 
               alt="" 
               class="d-none" 
               style="width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0;">
          <div id="preview-placeholder" class="text-center text-muted" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <i class="ri-image-line" style="font-size: 3rem; opacity: 0.3;"></i>
            <p class="mt-2 small mb-0">{% trans "La imagen se mostrar√° aqu√≠" %}</p>
          </div>
        </div>
        <label class="form-label" for="id_imagen">{% trans "Subir imagen" %}</label>
        {{ form.imagen|add_class:"form-control" }}
        {% if form.imagen.errors %}
          <div class="invalid-feedback d-block">{{ form.imagen.errors|join:', ' }}</div>
        {% endif %}
        <div class="form-text">
          <i class="ri-information-line me-1"></i>{% trans "Formatos permitidos: JPG, PNG, WEBP. M√°ximo 3MB." %}
        </div>
      </div>
    </div>
    <div class="d-grid mt-3">
      <button class="btn btn-primary" type="submit"><i class="ri-send-plane-line me-1"></i>{% trans "Publicar" %}</button>
      <a href="{% url 'admin_evento_list' %}" class="btn btn-outline-primary mt-2">{% trans "Cancelar" %}</a>
    </div>
  </div>
</form>

<script>
let autocomplete; // Variable global para el autocomplete

(function(){
  const $ = (sel) => document.querySelector(sel);
  const titulo = $('#id_titulo');
  const nombre = $('#id_nombre');
  const desc = $('#id_descripcion_corta');
  const fecha = $('#id_fecha');
  const precio = $('#id_precio');
  const tipoEvento = $('#id_tipo_evento');
  const tituloCount = $('#titulo-count');
  const descCount = $('#desc-count');
  const slugBtn = $('#slugify-btn');
  const imgInput = $('#id_imagen');
  const preview = $('#preview-img');
  const presencialFields = document.querySelectorAll('.evento-presencial-fields');
  const virtualFields = document.querySelectorAll('.evento-virtual-fields');
  const lugarInput = $('#id_lugar');
  const latInput = $('#id_latitud');
  const lngInput = $('#id_longitud');
  const fechaPreview = document.getElementById('fecha-preview');
  let userTouchedSlug = false;

  // Funci√≥n para formatear fecha legible en espa√±ol
  function formatearFechaLegible(dateStr) {
    if (!dateStr) return '';
    
    const dt = new Date(dateStr);
    const opciones = { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    };
    
    return dt.toLocaleString('es-CO', opciones);
  }

  // Funci√≥n para formatear fecha para datetime-local input
  function formatearParaInput(fecha) {
    const year = fecha.getFullYear();
    const month = String(fecha.getMonth() + 1).padStart(2, '0');
    const day = String(fecha.getDate()).padStart(2, '0');
    const hours = String(fecha.getHours()).padStart(2, '0');
    const minutes = String(fecha.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  }

  // Actualizar preview cuando se cambie manualmente la fecha
  function updateFechaPreview() {
    if (fecha && fechaPreview) {
      if (fecha.value) {
        fechaPreview.innerHTML = `<strong>${formatearFechaLegible(fecha.value)}</strong>`;
      } else {
        fechaPreview.textContent = '{% trans "Selecciona una fecha futura." %}';
      }
    }
  }

  if (fecha && fechaPreview) {
    fecha.addEventListener('change', updateFechaPreview);
    
    // Mostrar preview inicial si ya hay valor
    updateFechaPreview();
  }

  function toggleEventoFields() {
    if (!tipoEvento) return;
    const tipo = tipoEvento.value;
    
    if (tipo === 'virtual') {
      presencialFields.forEach(el => el.style.display = 'none');
      virtualFields.forEach(el => el.style.display = 'block');
    } else {
      presencialFields.forEach(el => el.style.display = 'block');
      virtualFields.forEach(el => el.style.display = 'none');
    }
  }

  function slugify(str){
    return (str||'')
      .toString().normalize('NFD').replace(/\p{Diacritic}/gu, '')
      .toLowerCase().replace(/[^a-z0-9]+/g,'-')
      .replace(/(^-|-$)/g,'').slice(0,140);
  }
  function updateCount(el, counterEl, max){
    if(!el || !counterEl) return;
    const val = (el.value||'');
    counterEl.textContent = `${val.length}`;
    if(val.length > max){
      el.classList.add('is-invalid');
    } else {
      el.classList.remove('is-invalid');
    }
  }
  function validateFecha(){
    if(!fecha) return;
    const val = fecha.value;
    if(!val) return;
    const dt = new Date(val);
    const now = new Date();
    const errorMsg = document.querySelector('.fecha-error-msg');
    
    // Solo validar que no sea fecha pasada
    if(dt.getTime() < now.getTime()){
      fecha.classList.add('is-invalid');
      if(errorMsg){
        errorMsg.textContent = '{% trans "La fecha debe ser futura." %}';
        errorMsg.style.display = 'block';
      }
    } else {
      fecha.classList.remove('is-invalid');
      if(errorMsg){ errorMsg.style.display = 'none'; }
    }
  }
  function numbersOnly(e){
    const v = (e.target.value||'');
    e.target.value = v.replace(/\D+/g,'');
  }
  function normalizePrecio(){
    if(!precio) return;
    if(precio.value === '') precio.value = '0';
    if(Number(precio.value) < 0){
      precio.value = '0';
    }
  }
  
  titulo && titulo.addEventListener('input', ()=> updateCount(titulo, tituloCount, 120));
  desc && desc.addEventListener('input', ()=> updateCount(desc, descCount, 500));
  nombre && nombre.addEventListener('input', ()=> { userTouchedSlug = true; });
  slugBtn && slugBtn.addEventListener('click', ()=> { if(titulo && nombre){ nombre.value = slugify(nombre.value||titulo.value); userTouchedSlug = true; } });
  titulo && titulo.addEventListener('input', ()=> { if(!userTouchedSlug && nombre){ nombre.value = slugify(titulo.value); } });
  fecha && fecha.addEventListener('change', validateFecha);
  
  // Formateo autom√°tico de precio en formato colombiano (separador de miles con punto)
  function formatPrecioCOP(input) {
    if (!input) return;
    
    // Obtener solo d√≠gitos
    let value = input.value.replace(/\D/g, '');
    
    // Si est√° vac√≠o, dejar vac√≠o (no forzar 0 a√∫n)
    if (value === '') {
      input.value = '';
      return;
    }
    
    // Convertir a n√∫mero y formatear con separador de miles
    let number = parseInt(value, 10);
    if (isNaN(number)) {
      input.value = '';
      return;
    }
    
    // Formatear: 1.000, 1.000.000, etc.
    input.value = number.toLocaleString('es-CO').replace(/,/g, '.');
  }
  
  precio && precio.addEventListener('input', () => formatPrecioCOP(precio));
  precio && precio.addEventListener('blur', () => {
    if (!precio) return;
    // Si est√° vac√≠o al salir del campo, poner 0
    if (precio.value === '') {
      precio.value = '0';
    }
  });
  
  tipoEvento && tipoEvento.addEventListener('change', toggleEventoFields);
  
  // init
  updateCount(titulo, tituloCount, 120);
  updateCount(desc, descCount, 500);
  validateFecha();
  toggleEventoFields();
  
  // Formatear precio inicial si existe
  if (precio && precio.value) {
    formatPrecioCOP(precio);
  }
  
  // Inicializar Google Places Autocomplete
  if (lugarInput) {
    if (typeof google !== 'undefined' && google.maps && google.maps.places) {
      try {
        autocomplete = new google.maps.places.Autocomplete(lugarInput, {
          componentRestrictions: { country: 'co' },
          fields: ['formatted_address', 'geometry', 'name', 'address_components'],
          language: 'es',
          types: ['address']
        });
        
        autocomplete.addListener('place_changed', function() {
          const place = autocomplete.getPlace();
          
          if (!place.geometry) {
            console.warn('‚ö†Ô∏è No se encontraron detalles para:', place.name);
            return;
          }
          
          const lat = place.geometry.location.lat();
          const lng = place.geometry.location.lng();
          
          if (latInput) latInput.value = lat;
          if (lngInput) lngInput.value = lng;
          
          console.log('‚úÖ Coordenadas guardadas:', { lat, lng, direccion: place.formatted_address });
        });
        
        console.log('‚úÖ Google Maps Autocomplete configurado');
      } catch (error) {
        console.warn('‚ö†Ô∏è Error al configurar Google Maps:', error);
      }
    }
  }
  
  // Preview de imagen
  const imageInput = document.getElementById('id_imagen') || document.querySelector('input[name="imagen"]');
  const previewImg = document.getElementById('preview-img');
  const previewPlaceholder = document.getElementById('preview-placeholder');
  
  console.log('Inicializando preview de imagen...', {
    imageInput: !!imageInput,
    previewImg: !!previewImg, 
    previewPlaceholder: !!previewPlaceholder
  });
  
  if(imageInput && previewImg && previewPlaceholder){
    console.log('‚úÖ Preview de imagen configurado');
    
    // Verificar si ya hay imagen al cargar (modo edici√≥n)
    {% if form.instance and form.instance.imagen %}
      previewImg.src = '{{ form.instance.imagen.url }}';
      previewImg.classList.remove('d-none');
      previewPlaceholder.style.display = 'none';
    {% else %}
      previewImg.src = '';
      previewImg.classList.add('d-none');
      previewPlaceholder.style.display = 'block';
    {% endif %}
    
    imageInput.addEventListener('change', function(e){
      console.log('Archivo seleccionado:', e.target.files);
      const f = e.target.files && e.target.files[0];
      
      if(!f){
        previewImg.src = '';
        previewImg.classList.add('d-none');
        previewPlaceholder.style.display = 'block';
        return;
      }
      
      const okTypes = ['image/jpeg','image/png','image/webp'];
      const maxSize = 3 * 1024 * 1024;
      
      if(!okTypes.includes(f.type)){
        alert('{% trans "‚ùå Formato no v√°lido. Usa JPG, PNG o WEBP." %}');
        imageInput.value = '';
        previewImg.classList.add('d-none');
        previewPlaceholder.style.display = 'block';
        return;
      }
      
      if(f.size > maxSize){
        alert('{% trans "‚ùå Archivo muy grande" %}' + ' (' + (f.size / 1024 / 1024).toFixed(2) + 'MB). {% trans "M√°x: 3MB" %}');
        imageInput.value = '';
        previewImg.classList.add('d-none');
        previewPlaceholder.style.display = 'block';
        return;
      }
      
      console.log('Cargando imagen con FileReader...');
      const reader = new FileReader();
      reader.onload = function(event){
        console.log('Imagen cargada, mostrando preview');
        previewImg.src = event.target.result;
        previewImg.classList.remove('d-none');
        previewPlaceholder.style.display = 'none';
      };
      reader.onerror = function(error){
        console.error('Error al cargar imagen:', error);
      };
      reader.readAsDataURL(f);
    });
  } else {
    console.error('‚ùå No se encontraron elementos para preview:', {
      imageInput: !!imageInput, 
      previewImg: !!previewImg, 
      previewPlaceholder: !!previewPlaceholder
    });
  }
})();
</script>

{% endblock %}