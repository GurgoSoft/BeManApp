{% extends "base.html" %}
{% load i18n %}
{% load form_extras %}
{% block title %}{{ modo|title }} {% trans "Evento" %}{% endblock %}
{% block extra_head %}
<!-- Google Maps Places API -->
<script>
// Handler de errores de autenticaci√≥n
window.gm_authFailure = function() {
  console.error('‚ùå ERROR DE AUTENTICACI√ìN: La API Key no es v√°lida o las APIs no est√°n habilitadas');
  console.log('üëâ Ve a: https://console.cloud.google.com/apis/library');
  console.log('üëâ Habilita: Maps JavaScript API y Places API');
};
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAc7L-zDl-Izz1RmyCRniU97l8ehcknvLs&libraries=places&language=es&region=CO" 
        onerror="console.error('‚ùå ERROR DE RED: No se pudo cargar el script de Google Maps')"></script>
<script>
// Verificar si se carg√≥ correctamente
if (typeof google !== 'undefined' && google.maps) {
  console.log('‚úÖ Google Maps script cargado exitosamente');
} else {
  console.error('‚ùå Google Maps no est√° disponible despu√©s de cargar el script');
}
</script>
{% endblock %}
{% block content %}
<h1 class="mb-3">{{ modo|title }} {% trans "Evento" %}</h1>

<div class="alert alert-info" role="alert">
  <div class="fw-semibold mb-1">{% trans "Tips para publicar" %}</div>
  <ul class="mb-0 ps-3">
    <li>{% trans "Para hoy: m√≠nimo 2 horas de anticipaci√≥n; otros d√≠as: 5 minutos" %}</li>
    <li>{% trans "Imagen JPG/PNG/WEBP (m√°x. 3MB)" %}</li>
    <li>{% trans "Precio en COP enteros (0 si es gratuito)" %}</li>
  </ul>
</div>

<form method="post" enctype="multipart/form-data" class="row g-4 needs-validation" novalidate>
  {% csrf_token %}
  {% if form.non_field_errors %}
  <div class="col-12">
    <div class="alert alert-danger" role="alert">
      {% for err in form.non_field_errors %}
        <div>{{ err }}</div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header"><i class="ri-information-line me-1"></i>{% trans "Detalles del evento" %}</div>
      <div class="card-body row g-3">
        <div class="col-12">
          <label class="form-label" for="id_titulo">{% trans "T√≠tulo" %}</label>
          {{ form.titulo|add_class:"form-control" }}
          {% if form.titulo.errors %}
            <div class="invalid-feedback d-block">{{ form.titulo.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text"><span id="titulo-count">0</span>/120</div>
        </div>
        <div class="col-12">
          <label class="form-label" for="id_nombre">{% trans "Nombre interno (slug)" %}</label>
          <div class="input-group">
            {{ form.nombre|add_class:"form-control" }}
            <button class="btn btn-outline-secondary" type="button" id="slugify-btn">{% trans "Auto" %}</button>
          </div>
          {% if form.nombre.errors %}
            <div class="invalid-feedback d-block">{{ form.nombre.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text">{% trans "Se usa como slug interno √∫nico." %}</div>
        </div>
        <div class="col-12">
          <label class="form-label" for="id_descripcion_corta">{% trans "Descripci√≥n corta" %}</label>
          {{ form.descripcion_corta|add_class:"form-control" }}
          {% if form.descripcion_corta.errors %}
            <div class="invalid-feedback d-block">{{ form.descripcion_corta.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text"><span id="desc-count">0</span>/500</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><i class="ri-calendar-event-line me-1"></i>{% trans "Log√≠stica" %}</div>
      <div class="card-body row g-3">
        <div class="col-md-6">
          <label class="form-label" for="id_tipo_evento">{% trans "Tipo de evento" %}</label>
          {{ form.tipo_evento|add_class:"form-select" }}
          {% if form.tipo_evento.errors %}
            <div class="invalid-feedback d-block">{{ form.tipo_evento.errors|join:', ' }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label" for="id_fecha">{% trans "Fecha y hora" %}</label>
          <div class="input-group">
            <span class="input-group-text"><i class="ri-time-line"></i></span>
            {{ form.fecha|add_class:"form-control" }}
          </div>
          {% if form.fecha.errors %}
            <div class="invalid-feedback d-block">{{ form.fecha.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text">{% trans "Si es hoy, m√≠nimo 2 horas de anticipaci√≥n; otros d√≠as, al menos 5 minutos (m√°x. 2 a√±os)." %}</div>
        </div>
        
        <!-- Campos para evento presencial -->
        <div class="col-12 evento-presencial-fields">
          <label class="form-label" for="id_lugar">{% trans "Direcci√≥n del lugar" %}</label>
          {{ form.lugar|add_class:"form-control" }}
          {% if form.lugar.errors %}
            <div class="invalid-feedback d-block">{{ form.lugar.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text">
            <i class="ri-map-pin-line me-1"></i>
            {% trans "Comienza a escribir la direcci√≥n y selecciona una opci√≥n de las sugerencias." %}
          </div>
          {{ form.latitud }}
          {{ form.longitud }}
        </div>

        <!-- Campos para evento virtual -->
        <div class="col-12 evento-virtual-fields" style="display:none;">
          <label class="form-label" for="id_plataforma_virtual">{% trans "Plataforma virtual" %}</label>
          {{ form.plataforma_virtual|add_class:"form-select" }}
          {% if form.plataforma_virtual.errors %}
            <div class="invalid-feedback d-block">{{ form.plataforma_virtual.errors|join:', ' }}</div>
          {% endif %}
        </div>
        <div class="col-12 evento-virtual-fields" style="display:none;">
          <label class="form-label" for="id_link_virtual">{% trans "Link de la reuni√≥n" %}</label>
          <div class="input-group">
            <span class="input-group-text"><i class="ri-vidicon-line"></i></span>
            {{ form.link_virtual|add_class:"form-control" }}
          </div>
          {% if form.link_virtual.errors %}
            <div class="invalid-feedback d-block">{{ form.link_virtual.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text">{% trans "Link completo (ej: https://zoom.us/j/123456789)" %}</div>
        </div>

        <div class="col-md-6">
          <label class="form-label" for="id_precio">{% trans "Precio" %}</label>
          <div class="input-group">
            <span class="input-group-text">COP</span>
            {{ form.precio|add_class:"form-control" }}
          </div>
          {% if form.precio.errors %}
            <div class="invalid-feedback d-block">{{ form.precio.errors|join:', ' }}</div>
          {% endif %}
          <div class="form-text">{% trans "Solo n√∫meros enteros en COP. 0 si es gratuito." %}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card">
      <div class="card-header"><i class="ri-image-add-line me-1"></i>{% trans "Imagen de portada" %}</div>
      <div class="card-body">
        <div class="mb-3 text-center">
          <img id="preview-img" src="{% if form.instance and form.instance.imagen %}{{ form.instance.imagen.url }}{% endif %}" alt="preview" class="rounded border w-100" style="max-height: 220px; object-fit: cover; background:#111;">
        </div>
        <label class="form-label" for="id_imagen">{% trans "Subir imagen" %}</label>
        {{ form.imagen|add_class:"form-control" }}
        {% if form.imagen.errors %}
          <div class="invalid-feedback d-block">{{ form.imagen.errors|join:', ' }}</div>
        {% endif %}
        <div class="form-text">{% trans "Formatos permitidos: JPG, PNG, WEBP. M√°x 3MB." %}</div>
      </div>
    </div>
    <div class="d-grid mt-3">
      <button class="btn btn-primary" type="submit"><i class="ri-send-plane-line me-1"></i>{% trans "Publicar" %}</button>
      <a href="{% url 'admin_evento_list' %}" class="btn btn-outline-primary mt-2">{% trans "Cancelar" %}</a>
    </div>
  </div>
</form>

<script>
let autocomplete; // Variable global para el autocomplete

(function(){
  const $ = (sel) => document.querySelector(sel);
  const titulo = $('#id_titulo');
  const nombre = $('#id_nombre');
  const desc = $('#id_descripcion_corta');
  const fecha = $('#id_fecha');
  const precio = $('#id_precio');
  const tipoEvento = $('#id_tipo_evento');
  const tituloCount = $('#titulo-count');
  const descCount = $('#desc-count');
  const slugBtn = $('#slugify-btn');
  const imgInput = $('#id_imagen');
  const preview = $('#preview-img');
  const presencialFields = document.querySelectorAll('.evento-presencial-fields');
  const virtualFields = document.querySelectorAll('.evento-virtual-fields');
  const lugarInput = $('#id_lugar');
  const latInput = $('#id_latitud');
  const lngInput = $('#id_longitud');
  let userTouchedSlug = false;

  function toggleEventoFields() {
    if (!tipoEvento) return;
    const tipo = tipoEvento.value;
    
    if (tipo === 'virtual') {
      presencialFields.forEach(el => el.style.display = 'none');
      virtualFields.forEach(el => el.style.display = 'block');
    } else {
      presencialFields.forEach(el => el.style.display = 'block');
      virtualFields.forEach(el => el.style.display = 'none');
    }
  }

  function slugify(str){
    return (str||'')
      .toString().normalize('NFD').replace(/\p{Diacritic}/gu, '')
      .toLowerCase().replace(/[^a-z0-9]+/g,'-')
      .replace(/(^-|-$)/g,'').slice(0,140);
  }
  function updateCount(el, counterEl, max){
    if(!el || !counterEl) return;
    const val = (el.value||'');
    counterEl.textContent = `${val.length}`;
    if(val.length > max){
      el.classList.add('is-invalid');
    } else {
      el.classList.remove('is-invalid');
    }
  }
  function validateFecha(){
    if(!fecha) return;
    const val = fecha.value;
    if(!val) return;
    const dt = new Date(val);
    const now = new Date();
    const min = new Date(now.getTime() + 5*60000);
    const max = new Date(now.getTime() + 2*365*24*60*60000);
    if(dt < min || dt > max){
      fecha.classList.add('is-invalid');
    } else {
      fecha.classList.remove('is-invalid');
    }
  }
  function numbersOnly(e){
    const v = (e.target.value||'');
    e.target.value = v.replace(/\D+/g,'');
  }
  function normalizePrecio(){
    if(!precio) return;
    if(precio.value === '') precio.value = '0';
    if(Number(precio.value) < 0){
      precio.value = '0';
    }
  }
  
  titulo && titulo.addEventListener('input', ()=> updateCount(titulo, tituloCount, 120));
  desc && desc.addEventListener('input', ()=> updateCount(desc, descCount, 500));
  nombre && nombre.addEventListener('input', ()=> { userTouchedSlug = true; });
  slugBtn && slugBtn.addEventListener('click', ()=> { if(titulo && nombre){ nombre.value = slugify(nombre.value||titulo.value); userTouchedSlug = true; } });
  titulo && titulo.addEventListener('input', ()=> { if(!userTouchedSlug && nombre){ nombre.value = slugify(titulo.value); } });
  fecha && fecha.addEventListener('change', validateFecha);
  precio && precio.addEventListener('input', numbersOnly);
  precio && precio.addEventListener('blur', normalizePrecio);
  tipoEvento && tipoEvento.addEventListener('change', toggleEventoFields);
  
  // init
  updateCount(titulo, tituloCount, 120);
  updateCount(desc, descCount, 500);
  validateFecha();
  toggleEventoFields();
  
  // Inicializar Google Places Autocomplete
  if (lugarInput) {
    console.log('üîç Verificando Google Maps...');
    
    if (typeof google === 'undefined') {
      console.error('‚ùå Google Maps no se carg√≥. Verifica la API Key y que las APIs est√©n habilitadas.');
      return;
    }
    
    if (!google.maps || !google.maps.places) {
      console.error('‚ùå Google Maps Places no est√° disponible');
      return;
    }
    
    console.log('‚úÖ Google Maps disponible, inicializando autocomplete...');
    
    try {
      autocomplete = new google.maps.places.Autocomplete(lugarInput, {
        componentRestrictions: { country: 'co' },
        fields: ['formatted_address', 'geometry', 'name', 'address_components'],
        language: 'es',
        types: ['address']
      });
      
      console.log('‚úÖ Autocomplete creado, agregando listener...');
      
      autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        console.log('üìç Place changed:', place);
        
        if (!place.geometry) {
          console.warn('‚ö†Ô∏è No se encontraron detalles para:', place.name);
          return;
        }
        
        const lat = place.geometry.location.lat();
        const lng = place.geometry.location.lng();
        
        if (latInput) latInput.value = lat;
        if (lngInput) lngInput.value = lng;
        
        console.log('‚úÖ Coordenadas guardadas:', { lat, lng, direccion: place.formatted_address });
      });
      
      console.log('‚úÖ Autocomplete configurado correctamente');
    } catch (error) {
      console.error('‚ùå Error al configurar autocomplete:', error);
    }
  }
  
  if(imgInput && preview){
    imgInput.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const okTypes = ['image/jpeg','image/png','image/webp'];
      if(!okTypes.includes(f.type) || f.size > 3*1024*1024){
        imgInput.value = '';
        alert('Archivo inv√°lido. Usa JPG, PNG o WEBP, m√°x 3MB.');
        return;
      }
      const url = URL.createObjectURL(f);
      preview.src = url;
    });
  }
})();
</script>

{% endblock %}