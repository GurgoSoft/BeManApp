{% load i18n static %}
<div class="comment-item py-3 border-bottom position-relative" data-comment-id="{{ c.pk }}">
  <div class="d-flex align-items-start gap-3">
    <div class="flex-shrink-0">
      {% if c.usuario.foto_perfil %}
        <img src="{{ c.usuario.foto_perfil.url }}" class="avatar-sm rounded-circle" style="width:42px;height:42px;object-fit:cover;" alt="{{ c.usuario.username }}">
      {% else %}
        <img src="{% static 'img/default_avatar.png' %}" class="avatar-sm rounded-circle" style="width:42px;height:42px;object-fit:cover;" alt="{{ c.usuario.username }}">
      {% endif %}
    </div>
    <div class="flex-grow-1 min-w-0">
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="fw-semibold">{{ c.usuario.username|default:c.usuario.email }}</span>
        <small class="text-muted">{{ c.fecha|date:"d M H:i" }}</small>
        <small class="text-muted" id="comment-meta-{{ c.pk }}">· <i class="ri-thumb-up-line align-middle me-1"></i><span class="align-middle meta-likes-count" data-comment-id="{{ c.pk }}">{{ c.likes_count|default:0 }}</span> · <i class="ri-chat-3-line align-middle me-1"></i><span class="align-middle replies-count" data-comment-id="{{ c.pk }}">{{ c.replies_count|default:0 }}</span>
          {% with rc=c.replies_count|default:0 %}
            {% if rc or c.respuestas.all|length %}
              <button class="btn btn-sm btn-link text-decoration-none text-muted btn-replies-toggle ms-1 p-0 align-baseline" type="button" data-target="#replies-{{ c.pk }}" aria-label="Toggle replies">
                <i class="ri-arrow-down-s-line"></i>
              </button>
            {% endif %}
          {% endwith %}
        </small>
      </div>
      <div class="mt-1 comment-text" data-comment-id="{{ c.pk }}">{{ c.texto }}</div>
      <div class="d-flex align-items-center gap-2 mt-2">
        {% if user.is_authenticated %}
          <button type="button" class="btn btn-sm btn-like-comentario btn-icon {% if c.pk in user_likes %}btn-like-active{% else %}btn-like-inactive{% endif %}"
                  data-like-url="{% url 'like_comentario' c.pk %}" data-comment-id="{{ c.pk }}" aria-label="{% trans 'Dar like' %}">
            <i class="ri-thumb-up-line"></i>
            <span class="comment-like-count" data-comment-id="{{ c.pk }}">{{ c.likes_count|default:0 }}</span>
          </button>
          <button type="button" class="btn btn-sm btn-outline-primary btn-reply-toggle" data-target="#reply-box-{{ c.pk }}"><i class="ri-reply-line"></i></button>
          {% if user == c.usuario %}
            <button type="button" class="btn btn-sm btn-outline-info btn-edit-toggle" data-target="#edit-box-{{ c.pk }}"><i class="ri-edit-line"></i></button>
          {% endif %}
          {% if user == c.usuario or user == c.historia.usuario %}
          <form method="post" action="{% url 'eliminar_comentario' c.pk %}" class="d-inline delete-form" data-comment-id="{{ c.pk }}" data-confirm="{% trans '¿Eliminar este comentario?' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger"><i class="ri-delete-bin-line"></i></button>
          </form>
          {% endif %}
        {% endif %}
      </div>
      {% if user.is_authenticated and user == c.usuario %}
      <div id="edit-box-{{ c.pk }}" class="mt-2 d-none">
        <form method="post" action="{% url 'editar_comentario' c.pk %}" class="edit-form" data-comment-id="{{ c.pk }}">
          {% csrf_token %}
          <textarea name="texto" class="form-control form-control-sm" rows="2">{{ c.texto }}</textarea>
          <div class="d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-primary btn-sm"><i class="ri-check-line"></i> {% trans 'Guardar' %}</button>
            <button type="button" class="btn btn-outline-secondary btn-sm btn-cancel-edit" data-target="#edit-box-{{ c.pk }}">{% trans 'Cancelar' %}</button>
          </div>
        </form>
      </div>
      {% endif %}
      {% if user.is_authenticated %}
      <div id="reply-box-{{ c.pk }}" class="mt-2 d-none">
        <form method="post" action="{% url 'responder_comentario' c.pk %}" class="reply-form">
          {% csrf_token %}
          <textarea name="texto" class="form-control form-control-sm" rows="2" required placeholder="{% trans 'Escribe una respuesta...' %}"></textarea>
          <div class="d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-primary btn-sm"><i class="ri-send-plane-line"></i> {% trans 'Responder' %}</button>
            <button type="button" class="btn btn-outline-secondary btn-sm btn-cancel-reply" data-target="#reply-box-{{ c.pk }}">{% trans 'Cancelar' %}</button>
          </div>
        </form>
      </div>
      {% endif %}
      <div id="replies-{{ c.pk }}" class="replies replies-anim mt-3 ps-3 border-start d-none" style="--bs-border-color:rgba(255,255,255,.08)">
        {% for r in c.respuestas.all %}
          {% include 'foro/_comentario_item.html' with c=r %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>
