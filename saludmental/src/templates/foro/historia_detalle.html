{% extends "base.html" %}
{% load i18n %}
{% load foro_extras %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/detalleHistoria.css' %}">
<style>
/* Animación simple para feedback */
@keyframes like-pop { 0%{transform:scale(1)} 50%{transform:scale(1.15)} 100%{transform:scale(1)} }
.btn-like-anim { animation: like-pop 250ms ease-in-out; }
/* Refuerzo visual del feed para evitar transparencias y colapsos de margen */
#comments-feed { background-color: var(--bs-card-bg); }
</style>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 mb-4 animate__animated animate__fadeIn">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3">
                            {% if historia.usuario.foto_perfil %}
                                <img src="{{ historia.usuario.foto_perfil.url }}" alt="{{ historia.usuario.username }}" class="avatar" />
                            {% else %}
                                <img src="{% static 'img/default_avatar.png' %}" alt="{{ historia.usuario.username }}" class="avatar" />
                            {% endif %}
                        </div>
                        <div>
                            <h2 class="card-title mb-0">{{ historia.titulo }}</h2>
                            <small class="text-muted">
                                {% trans "Por" %} <b>{{ historia.usuario.username }}</b> &middot; {{ historia.fecha|date:"d M Y H:i" }}
                            </small>
                        </div>
                        {% if user == historia.usuario %}
                            <div class="ms-auto">
                                <a href="{% url 'editar_historia' historia.pk %}" class="btn btn-outline-info btn-sm me-2" title="{% trans 'Editar' %}">
                                    <i class="ri-edit-line"></i>
                                </a>
                                <form method="post" action="{% url 'eliminar_historia' historia.pk %}" class="d-inline" data-confirm="{% trans '¿Eliminar esta historia?' %}" onsubmit="return confirm(this.getAttribute('data-confirm'));">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger btn-sm" title="{% trans 'Eliminar' %}">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </form>
                            </div>
                        {% endif %}
                    </div>
                    <hr>
                    <p class="fs-5 mb-4" style="white-space: pre-line;">{{ historia.contenido }}</p>

                    <div class="d-flex gap-2 mb-3">
                        <!-- Botón like de historia sin recarga -->
                        <button
                            id="btn-like-historia"
                            class="btn btn-sm {% if liked_story %}btn-like-active{% else %}btn-like-inactive{% endif %}"
                            data-like-url="{% url 'like_historia' historia.pk %}">
                            <i class="ri-thumb-up-line"></i>
                            {% trans "Like" %} (<span id="story-like-count">{{ historia.like_set.count }}</span>)
                        </button>
                    </div>
                </div>
            </div>

                        <!-- Comentarios estilo feed -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-body p-0">
                                <div class="d-flex align-items-center justify-content-between px-3 pt-3 pb-2">
                                    <h4 class="mb-0 d-flex align-items-center gap-2"><i class="ri-chat-3-line"></i> {% trans "Comentarios" %}</h4>
                                    <span id="comments-total-badge" class="badge bg-primary-subtle text-primary" data-count="{{ comentarios_total|default:comentarios|length }}">{{ comentarios_total|default:comentarios|length }} {% trans "total" %}</span>
                                </div>
                                <div id="comments-feed" class="comments-feed" style="padding:0 12px 12px;">
                                    {% for comentario in comentarios %}
                                        {% include 'foro/_comentario_item.html' with c=comentario %}
                                    {% empty %}
                                        <div class="text-center text-muted py-4">{% trans "No hay comentarios aún." %}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                    <!-- Comentar -->
                    {% if user.is_authenticated and user != historia.usuario %}
                        <div id="comment-alert" class="mb-3"></div>
                        <form id="comment-form" method="post" action="{% url 'comentar_historia' historia.pk %}">
                            {% csrf_token %}
                            <div class="mb-3">
  <textarea name="texto" class="form-control" rows="3" required></textarea>
</div>
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="ri-send-plane-line"></i> {% trans "Comentar" %}
                            </button>
                        </form>
                    {% elif user == historia.usuario %}
                        <div class="alert alert-warning mb-0">
                            <i class="ri-error-warning-line"></i> {% trans "No puedes comentar tu propia historia." %}
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="ri-information-line"></i> {% trans "Inicia sesión para comentar." %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF desde cookie
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
}
const csrftoken = getCookie('csrftoken');

// Helpers de slide
function slideDown(el){
    if(!el) return; el.classList.remove('d-none'); el.classList.remove('is-collapsing'); el.style.maxHeight='0px'; void el.offsetHeight; el.classList.add('is-expanding'); el.style.maxHeight=el.scrollHeight+'px';
    const done=()=>{ el.classList.remove('is-expanding'); el.style.maxHeight=''; el.removeEventListener('transitionend', done); };
    el.addEventListener('transitionend', done);
}
function slideUp(el){
    if(!el) return; el.classList.remove('is-expanding'); el.style.maxHeight=el.scrollHeight+'px'; void el.offsetHeight; el.classList.add('is-collapsing'); el.style.maxHeight='0px';
    const done=()=>{ el.classList.remove('is-collapsing'); el.classList.add('d-none'); el.style.maxHeight=''; el.removeEventListener('transitionend', done); };
    el.addEventListener('transitionend', done);
}
function slideToggle(el){ if(!el) return; if(el.classList.contains('d-none')) slideDown(el); else slideUp(el); }

// Like/Unlike historia - actualizar en tiempo real
const btnStory = document.getElementById('btn-like-historia');
if (btnStory) {
  btnStory.addEventListener('click', async () => {
    console.log('[LIKE HISTORIA] Click');
    try {
      const res = await fetch(btnStory.dataset.likeUrl, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'same-origin'
      });
      if (!res.ok) return;
      const data = await res.json();
      console.log('[LIKE HISTORIA] Respuesta:', data);
      document.getElementById('story-like-count').textContent = data.likes_count;
      btnStory.classList.toggle('btn-like-active', data.liked);
      btnStory.classList.toggle('btn-like-inactive', !data.liked);
      btnStory.classList.add('btn-like-anim');
      setTimeout(() => btnStory.classList.remove('btn-like-anim'), 250);
      console.log('[LIKE HISTORIA] Contador actualizado a', data.likes_count);
    } catch (err) {
      console.error('[LIKE HISTORIA] Error:', err);
    }
  });
}// Like/Unlike comentarios (delegación) - con actualización en tiempo real
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.btn-like-comentario');
  if (!btn) return;
  e.preventDefault();
  try {
        console.log('[LIKE] Click en comentario', btn.dataset.commentId);
        const res = await fetch(btn.dataset.likeUrl, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
      credentials: 'same-origin'
    });
    if(res.redirected){ window.location.href = res.url; return; }
    if (!res.ok) return;
    const data = await res.json();
    
    // Actualizar AMBOS spans: el del botón y el del meta
    document.querySelectorAll(`.comment-like-count[data-comment-id="${data.comentario_id}"], .meta-likes-count[data-comment-id="${data.comentario_id}"]`).forEach(span => {
      span.textContent = data.likes_count;
    });
    
    // toggle clases en el botón
    btn.classList.toggle('btn-like-active', data.liked);
    btn.classList.toggle('btn-like-inactive', !data.liked);
    btn.classList.add('btn-like-anim');
    setTimeout(() => btn.classList.remove('btn-like-anim'), 250);
    console.log('[LIKE] Contador actualizado a', data.likes_count, '- liked:', data.liked);
  } catch (err) {
    console.error('[LIKE] Error:', err);
  }
});// Mostrar / ocultar cajas de respuesta y edición (delegación)
document.addEventListener('click', (e) => {
    const replyToggle = e.target.closest('.btn-reply-toggle');
    if (replyToggle) {
        const targetSel = replyToggle.getAttribute('data-target');
        const box = document.querySelector(targetSel);
                if (box) box.classList.toggle('d-none');
    }
    const editToggle = e.target.closest('.btn-edit-toggle');
    if (editToggle) {
        const targetSel = editToggle.getAttribute('data-target');
        const box = document.querySelector(targetSel);
                if (box) box.classList.toggle('d-none');
    }
    const cancelReply = e.target.closest('.btn-cancel-reply');
    if (cancelReply) {
        const targetSel = cancelReply.getAttribute('data-target');
        const box = document.querySelector(targetSel);
        if (box) box.classList.add('d-none');
    }
    const cancelEdit = e.target.closest('.btn-cancel-edit');
    if (cancelEdit) {
        const targetSel = cancelEdit.getAttribute('data-target');
        const box = document.querySelector(targetSel);
        if (box) box.classList.add('d-none');
    }

        // Toggle desplegar replies con animación
        const repliesToggle = e.target.closest('.btn-replies-toggle');
        if(repliesToggle){
            const sel = repliesToggle.getAttribute('data-target');
            const box = document.querySelector(sel);
            if(box){
                const icon = repliesToggle.querySelector('i');
                const willExpand = box.classList.contains('d-none');
                slideToggle(box);
                if(icon){
                    icon.classList.toggle('ri-arrow-down-s-line', !willExpand);
                    icon.classList.toggle('ri-arrow-up-s-line', willExpand);
                }
            }
        }
});

// Interceptar submit de editar comentario (AJAX)
document.addEventListener('submit', async (e)=>{
    const ef = e.target.closest('form.edit-form');
    if(!ef) return;
    e.preventDefault();
    const url = ef.getAttribute('action');
    const fd = new FormData(ef);
    const id = ef.getAttribute('data-comment-id') || ef.dataset.commentId || (ef.closest('[id^="edit-box-"]')?.id?.replace('edit-box-',''));
    const btn = ef.querySelector('button[type="submit"]'); const prev=btn?btn.innerHTML:null; if(btn){ btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> {% trans "Guardando" %}'; }
    try{
        const resp = await fetch(url, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrftoken}, credentials:'same-origin', body: fd});
        if(resp.redirected){ window.location.href = resp.url; return; }
        const ct = resp.headers.get('content-type')||'';
        if(!ct.includes('application/json')){ throw new Error('Non-JSON'); }
        const data = await resp.json();
        if(data && data.ok){
            const txt = document.querySelector('.comment-text[data-comment-id="' + (data.comentario_id || id) + '"]');
            if(txt){ txt.textContent = data.texto; }
            const box = document.getElementById('edit-box-' + (data.comentario_id || id));
            if(box) box.classList.add('d-none');
        } else {
            // Mostrar error sin cerrar la caja
            const msg = (data && data.error) || '{% trans "No se pudo guardar el comentario." %}';
            // inline
            let holder = ef.querySelector('.form-error');
            if(!holder){ holder = document.createElement('div'); holder.className='form-error text-warning small mt-1'; ef.appendChild(holder); }
            holder.textContent = msg;
        }
    }catch(_){}
    finally{ if(btn){ btn.disabled=false; btn.innerHTML=prev; } }
});

// Interceptar delete comentario/respuesta - usar modal de confirmación
document.addEventListener('submit', async (e)=>{
  const df = e.target.closest('form.delete-form');
  if(!df) return;
  e.preventDefault();
  
  const confirmMsg = df.getAttribute('data-confirm') || '{% trans "¿Eliminar este comentario?" %}';
  const url = df.getAttribute('action');
  const commentId = df.getAttribute('data-comment-id');
  const fd = new FormData(df);
  
  // Mostrar modal de confirmación
  window.showDeleteConfirmation(confirmMsg, async () => {
    console.log('[DELETE] Eliminando comentario', commentId);
    try{
      const resp = await fetch(url, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrftoken}, credentials:'same-origin', body: fd});
      if(resp.redirected){ window.location.href = resp.url; return; }
      const data = await resp.json();
      console.log('[DELETE] Respuesta:', data);
      if(data && data.ok){
        const item = document.querySelector('.comment-item[data-comment-id="' + data.deleted_id + '"]');
        if(item){
          item.classList.add('fade-out');
          setTimeout(() => item.remove(), 300);
          console.log('[DELETE] Comentario eliminado del DOM');
        }
        // Actualizar badge total en tiempo real
        const badge = document.getElementById('comments-total-badge');
        if(badge && data.total !== undefined){
          badge.setAttribute('data-count', String(data.total));
          badge.textContent = data.total + ' ' + ('{% trans "total" %}');
          console.log('[DELETE] Badge total actualizado a', data.total);
        }
        // Si es respuesta, actualizar contador de respuestas del padre en tiempo real
        if(data.parent_id){
          const rc = document.querySelector('.replies-count[data-comment-id="' + data.parent_id + '"]');
          if(rc && data.replies_count !== undefined){
            rc.textContent = String(data.replies_count);
            console.log('[DELETE] Contador de respuestas del padre actualizado a', data.replies_count);
          }
          const box = document.getElementById('replies-' + data.parent_id);
          if(box && data.replies_count === 0){
            slideUp(box);
            console.log('[DELETE] Cerrando bloque de respuestas vacío');
          }
        }
      }
    }catch(err){
      console.error('[DELETE] Error:', err);
    }
  }); // Fin de showDeleteConfirmation callback
});
// Interceptar responder (AJAX)
document.addEventListener('submit', async (e)=>{
    const rf = e.target.closest('form.reply-form');
    if(!rf) return;
    e.preventDefault();
    console.log('[RESPONDER] Iniciando respuesta...');
    const url = rf.getAttribute('action');
    const btn = rf.querySelector('button[type="submit"]');
    const prevBtn = btn ? btn.innerHTML : null;
    if(btn){ btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> {% trans "Enviando" %}'; }
    const fd = new FormData(rf);
    try{
        console.log('[RESPONDER] Enviando a:', url);
        const resp = await fetch(url, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrftoken}, credentials:'same-origin', body: fd});
        console.log('[RESPONDER] Respuesta status:', resp.status, 'redirected:', resp.redirected);
        if(resp.redirected){ window.location.href = resp.url; return; }
        const ct = resp.headers.get('content-type')||'';
        if(!ct.includes('application/json')){ console.error('[RESPONDER] No es JSON:', ct); throw new Error('Non-JSON'); }
        const data = await resp.json();
        console.log('[RESPONDER] Data recibida:', data);
        if(data && data.ok){
            const parentId = data.parent_id;
            console.log('[RESPONDER] Insertando respuesta en replies-' + parentId);
            const repliesBox = document.getElementById('replies-' + parentId);
            if(repliesBox){
                const wrap = document.createElement('div');
                wrap.innerHTML = data.html;
                const child = wrap.firstElementChild;
                if(child){
                    child.classList.add('flash-highlight');
                    repliesBox.appendChild(child);
                    console.log('[RESPONDER] Respuesta insertada');
                }
                const wasHidden = repliesBox.classList.contains('d-none');
                if(wasHidden){
                    console.log('[RESPONDER] Abriendo bloque de respuestas con slideDown');
                    slideDown(repliesBox);
                }
            } else {
                console.error('[RESPONDER] No se encontró replies-' + parentId);
            }
            const meta = document.getElementById('comment-meta-' + parentId);
            if(meta && !meta.querySelector('.btn-replies-toggle')){
                const btn = document.createElement('button');
                btn.type='button';
                btn.className='btn btn-sm btn-link text-decoration-none text-muted btn-replies-toggle ms-1 p-0 align-baseline';
                btn.setAttribute('data-target', '#replies-' + parentId);
                btn.setAttribute('aria-label','Toggle replies');
                btn.innerHTML='<i class="ri-arrow-up-s-line"></i>';
                meta.appendChild(btn);
                console.log('[RESPONDER] Botón toggle creado');
            } else if(meta){
                const icon = meta.querySelector('.btn-replies-toggle i');
                if(icon){
                    icon.classList.remove('ri-arrow-down-s-line');
                    icon.classList.add('ri-arrow-up-s-line');
                    console.log('[RESPONDER] Icono actualizado a flecha arriba');
                }
            }
            const rc = document.querySelector('.replies-count[data-comment-id="' + parentId + '"]');
            if(rc){
              const newCount = data.replies_count || (parseInt(rc.textContent||'0') + 1);
              rc.textContent = String(newCount);
              console.log('[RESPONDER] Contador replies actualizado a', newCount);
              // Actualizar también el contador en el meta
              const metaReplies = document.querySelector(`#comment-meta-${parentId} .replies-count`);
              if(metaReplies) metaReplies.textContent = String(newCount);
            }
            const badge = document.getElementById('comments-total-badge');
            if(badge && data.total !== undefined){ badge.setAttribute('data-count', String(data.total)); badge.textContent = data.total + ' ' + ('{% trans "total" %}'); console.log('[RESPONDER] Badge total actualizado:', data.total); }
            const txt = rf.querySelector('textarea[name="texto"]');
            if(txt) txt.value='';
            const replyBox = rf.closest('[id^="reply-box-"]');
            if(replyBox){
                replyBox.classList.add('d-none');
                console.log('[RESPONDER] Caja de respuesta cerrada');
            }
        } else {
            console.error('[RESPONDER] Error del servidor:', data ? data.error : 'sin data');
            alert((data && data.error) || '{% trans "No se pudo guardar la respuesta." %}');
        }
    }catch(err){
        console.error('[RESPONDER] Error en fetch:', err);
        alert('{% trans "Error de red al guardar respuesta." %}');
    } finally {
        if(btn){ btn.disabled=false; btn.innerHTML=prevBtn; }
    }
});

// Interceptar crear comentario (AJAX)
(function(){
    const form = document.getElementById('comment-form');
    if(!form) return;
    const alertBox = document.getElementById('comment-alert');
    function showAlert(msg, level){ if(!alertBox) return; const lvl=level||'danger'; alertBox.innerHTML = `<div class="alert alert-${lvl} alert-dismissible fade show" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`; setTimeout(()=>{ try{ const el = alertBox.querySelector('.alert'); if(el && window.bootstrap && bootstrap.Alert){ bootstrap.Alert.getOrCreateInstance(el).close(); } }catch(_){} alertBox.innerHTML=''; }, 3500); }
        form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const url = form.getAttribute('action'); const fd = new FormData(form); const txt = form.querySelector('textarea[name="texto"]'); const val=(txt && txt.value.trim())||''; if(val.length<2){ showAlert('{% trans "El comentario no puede estar vacío." %}','warning'); return; }
        try{
                const resp = await fetch(url, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrftoken}, credentials:'same-origin', body: fd});
                if(resp.redirected){ window.location.href = resp.url; return; }
                const data = await resp.json();
            if(data && data.ok){
                const feed = document.getElementById('comments-feed'); if(feed){ const wrap=document.createElement('div'); wrap.innerHTML=data.html; const el=wrap.firstElementChild; if(el){ el.classList.add('flash-highlight'); feed.prepend(el); try{ el.scrollIntoView({behavior:'smooth', block:'nearest'});}catch(_){} } }
                if(txt) txt.value=''; showAlert('{% trans "Comentario publicado." %}','success');
                const badge = document.getElementById('comments-total-badge'); if(badge && data.total !== undefined){ badge.setAttribute('data-count', String(data.total)); badge.textContent = data.total + ' ' + ('{% trans "total" %}'); }
            } else { showAlert((data && data.error) || '{% trans "Error al publicar el comentario." %}','danger'); }
        }catch(_){ showAlert('{% trans "Error de red" %}','danger'); }
    });
})();
</script>
{% endblock %}